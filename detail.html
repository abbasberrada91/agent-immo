<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>D√©tail du bien - Henri Martin Immobilier</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="drawer.css" />
    <style>
      .detail-header {
        background: var(--white);
        border-bottom: 1px solid var(--line);
        padding: 1.2rem 0;
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .detail-nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .back-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        color: var(--brand);
        font-weight: 600;
        padding: 0.5rem 1rem;
        border-radius: 999px;
        border: 1px solid var(--line);
        transition: all 0.2s;
      }

      .back-btn:hover {
        background: var(--bg);
        border-color: var(--brand);
      }

      .detail-container {
        padding: 2rem 0;
      }

      .property-header {
        margin-bottom: 2rem;
      }

      .property-badge-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .property-title {
        font-size: 2rem;
        margin: 0 0 0.5rem;
        font-weight: 700;
      }

      .property-location {
        color: var(--muted);
        font-size: 1.1rem;
        margin: 0;
      }

      .photo-gallery {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 0.5rem;
        margin-bottom: 2rem;
        border-radius: 1rem;
        overflow: hidden;
      }

      .main-photo {
        position: relative;
        grid-row: span 2;
        cursor: pointer;
      }

      .main-photo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .thumbnail {
        position: relative;
        cursor: pointer;
        overflow: hidden;
      }

      .thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        transition: transform 0.3s;
      }

      .thumbnail:hover img {
        transform: scale(1.05);
      }

      .photo-overlay {
        position: absolute;
        bottom: 1rem;
        right: 1rem;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 999px;
        font-weight: 600;
        font-size: 0.9rem;
      }

      .property-details {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
      }

      .details-section {
        background: var(--white);
        border-radius: 1rem;
        padding: 1.5rem;
        border: 1px solid var(--line);
      }

      .details-section h2 {
        margin: 0 0 1rem;
        font-size: 1.4rem;
      }

      .details-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .detail-item {
        padding: 1rem;
        background: var(--bg);
        border-radius: 0.5rem;
      }

      .detail-label {
        font-size: 0.85rem;
        color: var(--muted);
        margin-bottom: 0.3rem;
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.05em;
      }

      .detail-value {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--ink);
      }

      .features-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
      }

      .features-list li {
        padding: 0.6rem 1rem;
        background: var(--bg);
        border-radius: 0.5rem;
        font-weight: 500;
      }

      .features-list li::before {
        content: "‚úì ";
        color: var(--sale);
        font-weight: 700;
        margin-right: 0.5rem;
      }

      .description-section {
        background: var(--white);
        border-radius: 1rem;
        padding: 1.5rem;
        border: 1px solid var(--line);
        margin-top: 1rem;
      }

      .description-section h2 {
        margin: 0 0 1rem;
        font-size: 1.4rem;
      }

      .description-text {
        color: var(--ink);
        line-height: 1.7;
        font-size: 1rem;
      }

      .location-section {
        background: var(--white);
        border-radius: 1rem;
        padding: 1.5rem;
        border: 1px solid var(--line);
        margin-top: 1rem;
      }

      .location-section h2 {
        margin: 0 0 1rem;
        font-size: 1.4rem;
      }

      .address-details {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1rem;
      }

      .address-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: var(--bg);
        border-radius: 0.5rem;
      }

      .address-icon {
        width: 20px;
        height: 20px;
        color: var(--brand);
      }

      .map-placeholder {
        width: 100%;
        height: 300px;
        background: var(--bg);
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .rental-terms-section {
        background: var(--white);
        border-radius: 1rem;
        padding: 1.5rem;
        border: 1px solid var(--line);
        margin-top: 1rem;
      }

      .rental-terms-section h2 {
        margin: 0 0 1rem;
        font-size: 1.4rem;
      }

      .terms-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }

      .term-item {
        padding: 1rem;
        background: var(--bg);
        border-radius: 0.5rem;
      }

      .term-label {
        font-size: 0.85rem;
        color: var(--muted);
        margin-bottom: 0.3rem;
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.05em;
      }

      .term-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--ink);
      }

      .related-properties-section {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 2px solid var(--line);
      }

      .related-properties-section h2 {
        font-size: 1.8rem;
        margin-bottom: 1.5rem;
        text-align: center;
      }

      .related-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
      }

      .related-card {
        background: var(--white);
        border-radius: 1rem;
        overflow: hidden;
        border: 1px solid var(--line);
        transition: transform 0.2s, box-shadow 0.2s;
        text-decoration: none;
        color: inherit;
        display: block;
      }

      .related-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      }

      .related-card-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
      }

      .related-card-body {
        padding: 1rem;
      }

      .related-card-title {
        font-size: 1.1rem;
        font-weight: 700;
        margin: 0 0 0.5rem;
      }

      .related-card-location {
        color: var(--muted);
        font-size: 0.9rem;
        margin: 0 0 0.75rem;
      }

      .related-card-details {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
      }

      .related-card-specs {
        display: flex;
        gap: 1rem;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .related-card-price {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--brand);
      }

      .price-card {
        background: var(--white);
        border-radius: 1rem;
        padding: 1.5rem;
        border: 1px solid var(--line);
        position: sticky;
        top: 6rem;
      }

      .price-amount {
        font-size: 2rem;
        font-weight: 700;
        color: var(--brand);
        margin: 0 0 0.5rem;
      }

      .price-type {
        color: var(--muted);
        font-size: 0.9rem;
        margin-bottom: 1.5rem;
      }

      .contact-btn {
        display: block;
        width: 100%;
        padding: 1rem;
        background: var(--brand);
        color: white;
        border: none;
        border-radius: 0.5rem;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        transition: background 0.2s;
      }

      .contact-btn:hover {
        background: var(--brand-soft);
      }

      .brochure-link {
        display: block;
        width: 100%;
        padding: 1rem;
        background: var(--bg);
        color: var(--brand);
        border: 1px solid var(--line);
        border-radius: 0.5rem;
        font-weight: 600;
        text-align: center;
        text-decoration: none;
        margin-top: 1rem;
        transition: all 0.2s;
      }

      .brochure-link:hover {
        background: var(--brand);
        color: white;
        border-color: var(--brand);
      }

      /* Modal for full-size photos */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.95);
      }

      .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        max-width: 90vw;
        max-height: 90vh;
        position: relative;
      }

      .modal-content img {
        max-width: 100%;
        max-height: 90vh;
        object-fit: contain;
      }

      .modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        color: white;
        font-size: 2rem;
        font-weight: 700;
        cursor: pointer;
        background: rgba(0, 0, 0, 0.5);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1001;
      }

      .modal-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.5);
        color: white;
        font-size: 2rem;
        padding: 1rem;
        cursor: pointer;
        border-radius: 0.5rem;
        user-select: none;
      }

      .modal-prev {
        left: 1rem;
      }

      .modal-next {
        right: 1rem;
      }

      .modal-counter {
        position: absolute;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 999px;
        font-weight: 600;
      }

      @media (max-width: 960px) {
        .photo-gallery {
          grid-template-columns: 1fr;
        }

        .main-photo {
          grid-row: span 1;
          height: 300px;
        }

        .thumbnail {
          height: 150px;
        }

        .property-details {
          grid-template-columns: 1fr;
        }

        .details-grid {
          grid-template-columns: 1fr;
        }

        .features-list {
          grid-template-columns: 1fr;
        }

        .terms-grid {
          grid-template-columns: 1fr;
        }

        .related-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Mobile Drawer Menu -->
    <div id="drawer-overlay" class="drawer-overlay"></div>
    <aside id="mobile-drawer" class="mobile-drawer" aria-hidden="true">
      <div class="drawer-header">
        <span class="drawer-brand">Henri Martin Immobilier</span>
        <button id="drawer-close" class="drawer-close" aria-label="Fermer le menu">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <div class="drawer-search">
        <input type="search" placeholder="Rechercher sur le site..." aria-label="Rechercher sur le site" />
      </div>

      <nav class="drawer-nav">
        <div class="drawer-section">
          <button class="drawer-section-btn" aria-expanded="false" aria-controls="drawer-locations">
            <span>Locations</span>
            <svg class="drawer-chevron" width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <div id="drawer-locations" class="drawer-section-content">
            <a href="index.html#biens">Biens √† louer</a>
            <a href="services/estimation.html">Estimation locative</a>
            <a href="services/mise-en-location.html">Mise en location</a>
          </div>
        </div>

        <div class="drawer-section">
          <button class="drawer-section-btn" aria-expanded="false" aria-controls="drawer-ventes">
            <span>Ventes</span>
            <svg class="drawer-chevron" width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <div id="drawer-ventes" class="drawer-section-content">
            <a href="index.html#biens">Biens √† vendre</a>
            <a href="services/estimation.html">Estimation vente</a>
            <a href="ventes/off-market.html">Vendre en off-market</a>
          </div>
        </div>

        <div class="drawer-section">
          <button class="drawer-section-btn" aria-expanded="false" aria-controls="drawer-proprietaires">
            <span>Propri√©taires</span>
            <svg class="drawer-chevron" width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <div id="drawer-proprietaires" class="drawer-section-content">
            <a href="services/estimation.html">Estimation gratuite</a>
            <a href="services/rentabilite.html">Calcul de rentabilit√©</a>
            <a href="services/mise-en-location.html">Mise en location</a>
            <a href="services/modes-location.html">Modes de location</a>
          </div>
        </div>

        <div class="drawer-section">
          <button class="drawer-section-btn" aria-expanded="false" aria-controls="drawer-agence">
            <span>L'agence</span>
            <svg class="drawer-chevron" width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <div id="drawer-agence" class="drawer-section-content">
            <a href="agence/histoire.html">Histoire</a>
            <a href="agence/equipe.html">√âquipe</a>
            <a href="agence/temoignages.html">T√©moignages</a>
            <a href="agence/partenaires.html">Partenaires</a>
          </div>
        </div>

        <div class="drawer-section drawer-section-simple">
          <a href="blog.html" class="drawer-link">Blog</a>
        </div>
      </nav>

      <div class="drawer-footer">
        <a href="login.html" class="drawer-btn drawer-btn-primary">Se connecter</a>
        <a href="index.html#contact" class="drawer-btn drawer-btn-secondary">Contact</a>
      </div>
    </aside>

    <header class="detail-header">
      <div class="container detail-nav">
        <button id="burger-menu" class="burger-menu" aria-label="Ouvrir le menu" aria-expanded="false">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <a href="index.html" class="back-btn">
          <span>‚Üê</span>
          <span>Retour aux biens</span>
        </a>
        <a href="#top" class="brand">Henri Martin Immobilier</a>
      </div>
    </header>

    <main class="container detail-container">
      <div class="property-header">
        <div class="property-badge-row">
          <span class="badge" id="property-badge"></span>
          <span class="ref" id="property-ref"></span>
        </div>
        <h1 class="property-title" id="property-title"></h1>
        <p class="property-location" id="property-location"></p>
      </div>

      <div class="photo-gallery" id="photo-gallery">
        <!-- Photos will be inserted here -->
      </div>

      <div class="property-details">
        <div>
          <div class="details-section">
            <h2>Caract√©ristiques</h2>
            <div class="details-grid" id="details-grid">
              <!-- Details will be inserted here -->
            </div>
          </div>

          <div class="details-section" style="margin-top: 1rem;">
            <h2>√âquipements</h2>
            <ul class="features-list" id="features-list">
              <!-- Features will be inserted here -->
            </ul>
          </div>

          <div class="description-section" id="description-section">
            <h2>Description</h2>
            <div class="description-text" id="description-text">
              <!-- Description will be inserted here -->
            </div>
          </div>

          <div class="location-section">
            <h2>Localisation</h2>
            <div class="address-details" id="address-details">
              <!-- Address details will be inserted here -->
            </div>
            <div class="map-placeholder">
              üìç Carte interactive disponible prochainement
            </div>
          </div>

          <div class="rental-terms-section" id="rental-terms-section" style="display: none;">
            <h2>Conditions de location</h2>
            <div class="terms-grid" id="terms-grid">
              <!-- Rental terms will be inserted here -->
            </div>
          </div>
        </div>

        <div>
          <div class="price-card">
            <div class="price-amount" id="property-price"></div>
            <div class="price-type" id="price-type"></div>
            <a href="#contact" class="contact-btn">Contacter</a>
            <a href="#" id="brochure-link" class="brochure-link" target="_blank" rel="noopener noreferrer">
              Dossier complet Canva ‚Üí
            </a>
          </div>
        </div>
      </div>

      <div class="related-properties-section">
        <h2>Biens similaires</h2>
        <div class="related-grid" id="related-properties">
          <!-- Related properties will be inserted here -->
        </div>
      </div>
    </main>

    <!-- Photo Modal -->
    <div class="modal" id="photo-modal">
      <span class="modal-close" id="modal-close">&times;</span>
      <span class="modal-nav modal-prev" id="modal-prev">‚Äπ</span>
      <span class="modal-nav modal-next" id="modal-next">‚Ä∫</span>
      <div class="modal-content">
        <img id="modal-image" src="" alt="">
      </div>
      <div class="modal-counter" id="modal-counter"></div>
    </div>

    <footer>
      <p>¬© 2026 Henri Martin Immobilier ‚Äî Plateforme partenaire immobili√®re</p>
    </footer>
    <div style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: #999;">Build: DEV</div>

    <script>
      // Get property reference from URL
      const urlParams = new URLSearchParams(window.location.search);
      const propertyRef = urlParams.get('ref');

      let currentProperty = null;
      let currentPhotoIndex = 0;
      let photos = [];

      // Helper function to detect network errors
      function isNetworkError(error) {
        // Network errors are typically TypeError with specific messages
        // Note: Checks are intentionally broad to catch various network error scenarios
        // from the Fetch API (e.g., "Failed to fetch", "NetworkError", "Network request failed")
        if (!(error instanceof TypeError)) {
          return false;
        }
        const message = error.message.toLowerCase();
        return message.includes('fetch') || message.includes('network');
      }

      // Helper function to create a suggestion box with list items
      function createSuggestionBox(suggestions) {
        const div = document.createElement('div');
        div.style.cssText = 'text-align: left; max-width: 500px; margin: 0 auto; background: white; padding: 1rem; border-radius: 4px;';
        
        const title = document.createElement('p');
        title.style.cssText = 'color: #2d3748; margin-bottom: 0.5rem;';
        const strong = document.createElement('strong');
        strong.textContent = 'üí° Actions √† essayer:';
        title.appendChild(strong);
        div.appendChild(title);
        
        const ul = document.createElement('ul');
        ul.style.cssText = 'color: #4a5568; margin-left: 1.5rem;';
        suggestions.forEach(suggestion => {
          const li = document.createElement('li');
          li.textContent = suggestion;
          ul.appendChild(li);
        });
        div.appendChild(ul);
        
        return div;
      }

      // Load property data with retry logic and better error handling
      async function loadPropertyDetails(retryCount = 0) {
        const MAX_RETRIES = 3;
        const RETRY_DELAY_MS = 1000;

        try {
          const response = await fetch('biens.json', {
            cache: 'no-cache', // Ensure we get fresh data for real-time property listings
            headers: {
              'Accept': 'application/json'
            }
          });
          
          if (!response.ok) {
            // Provide specific error messages based on status code
            let errorMessage = `Erreur HTTP ${response.status}: `;
            switch (response.status) {
              case 404:
                errorMessage += 'Le fichier biens.json est introuvable.';
                break;
              case 403:
                errorMessage += 'Acc√®s refus√© au fichier biens.json.';
                break;
              case 500:
              case 502:
              case 503:
              case 504:
                errorMessage += 'Le serveur rencontre des difficult√©s.';
                break;
              default:
                errorMessage += 'Impossible de charger les donn√©es.';
            }
            throw new Error(errorMessage);
          }

          // Validate content type
          const contentType = response.headers.get('content-type');
          if (contentType && !contentType.includes('application/json')) {
            throw new Error(`Type de contenu invalide: ${contentType}. Le fichier doit √™tre au format JSON.`);
          }

          let data;
          try {
            data = await response.json();
          } catch (jsonError) {
            throw new Error(`Format JSON invalide: ${jsonError.message}`);
          }

          // Validate data structure
          if (!data || typeof data !== 'object') {
            throw new Error('Le fichier biens.json ne contient pas un objet JSON valide.');
          }

          if (!data.properties || !Array.isArray(data.properties)) {
            throw new Error('Le fichier biens.json doit contenir un tableau "properties".');
          }

          currentProperty = data.properties.find(p => p.reference === propertyRef);

          if (!currentProperty) {
            const container = document.querySelector('.detail-container');
            container.innerHTML = '';
            
            const div = document.createElement('div');
            div.style.cssText = 'text-align: center; padding: 3rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; margin: 2rem 0;';
            
            const h2 = document.createElement('h2');
            h2.style.cssText = 'color: #856404; margin-bottom: 1rem;';
            h2.textContent = '‚ö†Ô∏è Bien non trouv√©';
            
            const p1 = document.createElement('p');
            p1.style.cssText = 'color: #856404; margin-bottom: 1rem;';
            p1.textContent = 'Aucun bien trouv√© avec la r√©f√©rence: ';
            const strong = document.createElement('strong');
            strong.textContent = propertyRef || 'non sp√©cifi√©e';
            p1.appendChild(strong);
            
            const p2 = document.createElement('p');
            p2.style.cssText = 'color: #856404;';
            p2.textContent = 'üí° V√©rifiez que la r√©f√©rence est correcte ou ';
            const link = document.createElement('a');
            link.href = 'index.html';
            link.style.color = '#007bff';
            link.textContent = 'retournez √† la liste des biens';
            p2.appendChild(link);
            p2.appendChild(document.createTextNode('.'));
            
            div.appendChild(h2);
            div.appendChild(p1);
            div.appendChild(p2);
            container.appendChild(div);
            return;
          }

          displayProperty(currentProperty);
        } catch (error) {
          console.error('Error loading property:', error);
          
          // Handle network errors with retry logic
          if (isNetworkError(error) && retryCount < MAX_RETRIES) {
            console.warn(`Network error, retrying in ${RETRY_DELAY_MS}ms... (attempt ${retryCount + 1}/${MAX_RETRIES})`);
            setTimeout(() => loadPropertyDetails(retryCount + 1), RETRY_DELAY_MS);
            return;
          }
          
          // Build actionable error message for users using DOM methods to prevent XSS
          const container = document.querySelector('.detail-container');
          container.innerHTML = '';
          
          const mainDiv = document.createElement('div');
          mainDiv.style.cssText = 'text-align: center; padding: 3rem; background: #fff5f5; border: 1px solid #fc8181; border-radius: 8px; margin: 2rem 0;';
          
          const h2 = document.createElement('h2');
          h2.style.cssText = 'color: #e53e3e; margin-bottom: 1rem;';
          h2.textContent = '‚ùå Erreur de chargement';
          mainDiv.appendChild(h2);
          
          const errorP = document.createElement('p');
          errorP.style.cssText = 'color: #c53030; margin-bottom: 1rem;';
          errorP.textContent = error.message;
          mainDiv.appendChild(errorP);
          
          // Add actionable suggestions based on error type
          // Note: Error message checks are intentionally broad to catch related error scenarios
          // Our error messages include "Format JSON invalide" and "JSON" keywords
          if (isNetworkError(error)) {
            const suggestions = [
              'V√©rifiez votre connexion internet',
              'Rechargez la page (F5 ou Ctrl+R)',
              'V√©rifiez que le fichier biens.json existe'
            ];
            mainDiv.appendChild(createSuggestionBox(suggestions));
          } else if (error.message.includes('JSON')) {
            const suggestions = [
              'V√©rifiez la syntaxe JSON du fichier biens.json',
              'Utilisez un validateur JSON en ligne'
            ];
            mainDiv.appendChild(createSuggestionBox(suggestions));
          } else if (error.message.includes('404')) {
            const suggestions = [
              'V√©rifiez que biens.json existe √† la racine',
              'Assurez-vous que le fichier a √©t√© commit sur GitHub'
            ];
            mainDiv.appendChild(createSuggestionBox(suggestions));
          }
          
          const returnP = document.createElement('p');
          returnP.style.marginTop = '1rem';
          const returnLink = document.createElement('a');
          returnLink.href = 'index.html';
          returnLink.style.cssText = 'color: #007bff; text-decoration: underline;';
          returnLink.textContent = '‚Üê Retour √† l\'accueil';
          returnP.appendChild(returnLink);
          mainDiv.appendChild(returnP);
          
          container.appendChild(mainDiv);
        }
      }

      function displayProperty(property) {
        // Set title and location
        document.getElementById('property-title').textContent = property.title;
        document.getElementById('property-location').textContent = 
          `${property.city} ${property.district}`;

        // Set badge
        const badge = document.getElementById('property-badge');
        badge.textContent = property.transaction === 'vente' ? 'Vente' : 'Location';
        badge.classList.add(property.transaction === 'vente' ? 'sale' : 'rent');

        // Set reference
        document.getElementById('property-ref').textContent = `R√©f. ${property.reference}`;

        // Set price
        const priceElement = document.getElementById('property-price');
        const priceTypeElement = document.getElementById('price-type');
        if (property.transaction === 'location') {
          priceElement.textContent = `${property.price.toLocaleString('fr-FR')} ‚Ç¨`;
          priceTypeElement.textContent = 'par mois';
        } else {
          priceElement.textContent = `${property.price.toLocaleString('fr-FR')} ‚Ç¨`;
          priceTypeElement.textContent = '';
        }

        // Display photos
        // Check if property has images array, otherwise use single image
        photos = property.images || [property.image];
        displayPhotoGallery(photos);

        // Display details
        const detailsGrid = document.getElementById('details-grid');
        detailsGrid.innerHTML = `
          <div class="detail-item">
            <div class="detail-label">Surface</div>
            <div class="detail-value">${property.surface} m¬≤</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Pi√®ces</div>
            <div class="detail-value">${property.rooms}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Type</div>
            <div class="detail-value">${property.propertyType}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Transaction</div>
            <div class="detail-value">${property.transaction === 'vente' ? 'Vente' : 'Location'}</div>
          </div>
        `;

        // Display features
        const featuresList = document.getElementById('features-list');
        featuresList.innerHTML = property.features.map(feature => 
          `<li>${feature}</li>`
        ).join('');

        // Display description
        displayDescription(property);

        // Display location details
        displayLocationDetails(property);

        // Display rental terms (only for rentals)
        if (property.transaction === 'location') {
          displayRentalTerms(property);
        }

        // Display related properties
        displayRelatedProperties(property);

        // Set brochure link
        const brochureLink = document.getElementById('brochure-link');
        if (property.brochureUrl && property.brochureUrl !== 'null') {
          brochureLink.href = property.brochureUrl;
        } else {
          brochureLink.style.display = 'none';
        }
      }

      function displayPhotoGallery(photos) {
        const gallery = document.getElementById('photo-gallery');
        gallery.innerHTML = '';

        if (photos.length === 0) return;

        // Main photo
        const mainPhoto = document.createElement('div');
        mainPhoto.className = 'main-photo';
        mainPhoto.innerHTML = `
          <img src="${photos[0]}" alt="${currentProperty.alt || 'Photo principale'}">
          ${photos.length > 1 ? `<div class="photo-overlay">${photos.length} photos</div>` : ''}
        `;
        mainPhoto.addEventListener('click', () => openModal(0));
        gallery.appendChild(mainPhoto);

        // Thumbnails (show up to 4 more)
        const thumbnailsToShow = Math.min(photos.length - 1, 4);
        for (let i = 1; i <= thumbnailsToShow; i++) {
          const thumbnail = document.createElement('div');
          thumbnail.className = 'thumbnail';
          thumbnail.style.height = '250px';
          thumbnail.innerHTML = `<img src="${photos[i]}" alt="Photo ${i + 1}">`;
          thumbnail.addEventListener('click', () => openModal(i));
          gallery.appendChild(thumbnail);
        }

        // If more than 5 photos, show "+X more" overlay on last thumbnail
        if (photos.length > 5) {
          const lastThumbnail = gallery.querySelector('.thumbnail:last-child');
          if (lastThumbnail) {
            const overlay = document.createElement('div');
            overlay.className = 'photo-overlay';
            overlay.textContent = `+${photos.length - 5} photos`;
            overlay.style.top = '50%';
            overlay.style.left = '50%';
            overlay.style.transform = 'translate(-50%, -50%)';
            overlay.style.bottom = 'auto';
            overlay.style.right = 'auto';
            lastThumbnail.style.position = 'relative';
            lastThumbnail.appendChild(overlay);
          }
        }
      }

      /**
       * Display property description
       */
      function displayDescription(property) {
        const descriptionSection = document.getElementById('description-section');
        const descriptionText = document.getElementById('description-text');
        
        // Generate a description based on property data if not provided
        let description = property.description;
        
        if (!description) {
          // Generate default description
          const transactionText = property.transaction === 'vente' ? '√† vendre' : '√† louer';
          const roomText = property.rooms > 1 ? `${property.rooms} pi√®ces` : `${property.rooms} pi√®ce`;
          
          description = `${property.propertyType} ${transactionText} de ${property.surface} m¬≤ avec ${roomText}, `;
          description += `situ√©${property.propertyType === 'Appartement' || property.propertyType === 'Studio' ? '' : 'e'} `;
          description += `√† ${property.city}`;
          if (property.district) {
            description += `, ${property.district}`;
          }
          description += '. ';
          
          // Add features to description
          if (property.features && property.features.length > 0) {
            description += 'Ce bien dispose de : ' + property.features.join(', ') + '.';
          }
          
          // Add additional details if available
          if (property.bedrooms) {
            description += ` Il comprend ${property.bedrooms} chambre${property.bedrooms > 1 ? 's' : ''}.`;
          }
          
          if (property.elevator) {
            description += ' Un ascenseur est pr√©sent dans l\'immeuble.';
          }
        }
        
        descriptionText.textContent = description;
      }

      /**
       * Display location details with address
       */
      function displayLocationDetails(property) {
        const addressDetails = document.getElementById('address-details');
        
        let html = '';
        
        // City
        if (property.city) {
          html += `
            <div class="address-item">
              <svg class="address-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              <div>
                <div style="font-weight: 600;">${property.city}</div>
                ${property.district ? `<div style="font-size: 0.85rem; color: var(--muted);">${property.district}</div>` : ''}
              </div>
            </div>
          `;
        }
        
        // Property type
        html += `
          <div class="address-item">
            <svg class="address-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
            </svg>
            <div>
              <div style="font-weight: 600;">${property.propertyType}</div>
              <div style="font-size: 0.85rem; color: var(--muted);">${property.surface} m¬≤ - ${property.rooms} pi√®ce${property.rooms > 1 ? 's' : ''}</div>
            </div>
          </div>
        `;
        
        // Floor info (if available)
        if (property.floor !== undefined) {
          html += `
            <div class="address-item">
              <svg class="address-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
              </svg>
              <div>
                <div style="font-weight: 600;">√âtage ${property.floor}</div>
                <div style="font-size: 0.85rem; color: var(--muted);">${property.elevator ? 'Avec ascenseur' : 'Sans ascenseur'}</div>
              </div>
            </div>
          `;
        }
        
        addressDetails.innerHTML = html;
      }

      /**
       * Display rental terms for rental properties
       */
      function displayRentalTerms(property) {
        const termsSection = document.getElementById('rental-terms-section');
        const termsGrid = document.getElementById('terms-grid');
        
        termsSection.style.display = 'block';
        
        let html = '';
        
        // Monthly rent
        html += `
          <div class="term-item">
            <div class="term-label">Loyer mensuel</div>
            <div class="term-value">${property.price.toLocaleString('fr-FR')} ‚Ç¨</div>
          </div>
        `;
        
        // Deposit (default to 1 month rent if not specified)
        const deposit = property.deposit || property.price;
        html += `
          <div class="term-item">
            <div class="term-label">D√©p√¥t de garantie</div>
            <div class="term-value">${deposit.toLocaleString('fr-FR')} ‚Ç¨</div>
          </div>
        `;
        
        // Minimum lease duration
        const minDuration = property.minDuration || '1 an';
        html += `
          <div class="term-item">
            <div class="term-label">Dur√©e minimum</div>
            <div class="term-value">${minDuration}</div>
          </div>
        `;
        
        // Charges
        const charges = property.charges || 'Incluses';
        html += `
          <div class="term-item">
            <div class="term-label">Charges</div>
            <div class="term-value">${typeof charges === 'number' ? charges.toLocaleString('fr-FR') + ' ‚Ç¨' : charges}</div>
          </div>
        `;
        
        // Heating type
        if (property.heatingType) {
          html += `
            <div class="term-item">
              <div class="term-label">Chauffage</div>
              <div class="term-value">${property.heatingType.charAt(0).toUpperCase() + property.heatingType.slice(1)}</div>
            </div>
          `;
        }
        
        // Roommate allowed
        if (property.roommateAllowed !== undefined) {
          html += `
            <div class="term-item">
              <div class="term-label">Colocation</div>
              <div class="term-value">${property.roommateAllowed ? 'Autoris√©e' : 'Non autoris√©e'}</div>
            </div>
          `;
        }
        
        termsGrid.innerHTML = html;
      }

      /**
       * Display related properties (similar properties)
       */
      function displayRelatedProperties(property) {
        const relatedContainer = document.getElementById('related-properties');
        const PRICE_SIMILARITY_THRESHOLD = 0.5; // Match properties within 50% price range
        const MAX_RELATED_PROPERTIES = 3;
        
        // Load all properties to find similar ones
        fetch('biens.json', { cache: 'no-cache' })
          .then(response => response.json())
          .then(data => {
            // Find similar properties (same transaction type, similar price range, same city, but different reference)
            const similarProperties = data.properties
              .filter(p => 
                p.reference !== property.reference &&
                p.transaction === property.transaction &&
                (p.city === property.city || p.propertyType === property.propertyType) &&
                Math.abs(p.price - property.price) < property.price * PRICE_SIMILARITY_THRESHOLD
              )
              .slice(0, MAX_RELATED_PROPERTIES);
            
            if (similarProperties.length === 0) {
              relatedContainer.innerHTML = '<p style="text-align: center; color: var(--muted);">Aucun bien similaire disponible pour le moment.</p>';
              return;
            }
            
            relatedContainer.innerHTML = similarProperties.map(p => {
              const image = p.images?.[0] || p.image;
              return `
                <a href="detail.html?ref=${p.reference}" class="related-card">
                  <img src="${image}" alt="${p.title}" class="related-card-image">
                  <div class="related-card-body">
                    <h3 class="related-card-title">${p.title}</h3>
                    <p class="related-card-location">üìç ${p.city} ${p.district || ''}</p>
                    <div class="related-card-details">
                      <div class="related-card-specs">
                        <span>${p.surface} m¬≤</span>
                        <span>${p.rooms} pi√®ce${p.rooms > 1 ? 's' : ''}</span>
                      </div>
                    </div>
                    <div class="related-card-price">
                      ${p.price.toLocaleString('fr-FR')} ‚Ç¨${p.transaction === 'location' ? '/mois' : ''}
                    </div>
                  </div>
                </a>
              `;
            }).join('');
          })
          .catch(error => {
            console.error('Error loading related properties:', error);
            relatedContainer.innerHTML = '<p style="text-align: center; color: var(--muted);">Erreur lors du chargement des biens similaires.</p>';
          });
      }

      // Modal functionality
      function openModal(index) {
        currentPhotoIndex = index;
        showModalPhoto();
        document.getElementById('photo-modal').classList.add('active');
      }

      function closeModal() {
        document.getElementById('photo-modal').classList.remove('active');
      }

      function showModalPhoto() {
        const modal = document.getElementById('photo-modal');
        const img = document.getElementById('modal-image');
        const counter = document.getElementById('modal-counter');

        img.src = photos[currentPhotoIndex];
        counter.textContent = `${currentPhotoIndex + 1} / ${photos.length}`;

        // Show/hide navigation buttons
        document.getElementById('modal-prev').style.display = 
          currentPhotoIndex > 0 ? 'block' : 'none';
        document.getElementById('modal-next').style.display = 
          currentPhotoIndex < photos.length - 1 ? 'block' : 'none';
      }

      function nextPhoto() {
        if (currentPhotoIndex < photos.length - 1) {
          currentPhotoIndex++;
          showModalPhoto();
        }
      }

      function prevPhoto() {
        if (currentPhotoIndex > 0) {
          currentPhotoIndex--;
          showModalPhoto();
        }
      }

      // Event listeners
      document.getElementById('modal-close').addEventListener('click', closeModal);
      document.getElementById('modal-next').addEventListener('click', nextPhoto);
      document.getElementById('modal-prev').addEventListener('click', prevPhoto);

      // Close modal on outside click
      document.getElementById('photo-modal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeModal();
        }
      });

      // Keyboard navigation
      document.addEventListener('keydown', function(e) {
        const modal = document.getElementById('photo-modal');
        if (modal.classList.contains('active')) {
          if (e.key === 'Escape') closeModal();
          if (e.key === 'ArrowLeft') prevPhoto();
          if (e.key === 'ArrowRight') nextPhoto();
        }
      });

      // Load property on page load
      loadPropertyDetails();
    </script>
    <script src="drawer.js"></script>
  </body>
</html>
