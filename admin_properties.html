<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gestion des biens - Henri Martin Immobilier</title>
    <link rel="stylesheet" href="drawer.css">
    <link rel="stylesheet" href="styles.css">
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="api.js"></script>
    <script>
        // V√©rifier l'authentification au chargement de la page
        checkAuthentication();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 80px 20px 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        h1 {
            color: #2d3748;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #718096;
            font-size: 16px;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: #667eea;
            background: #f7faff;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .properties-table {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f7fafc;
        }

        th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
            color: #4a5568;
        }

        tr:hover {
            background: #f7fafc;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-vente {
            background: #e6fffa;
            color: #047857;
        }

        .badge-location {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-published {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-draft {
            background: #f3f4f6;
            color: #6b7280;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .action-btn-edit {
            background: #dbeafe;
            color: #1e40af;
        }

        .action-btn-edit:hover {
            background: #bfdbfe;
        }

        .action-btn-delete {
            background: #fee2e2;
            color: #991b1b;
        }

        .action-btn-delete:hover {
            background: #fecaca;
        }

        .action-btn-publish {
            background: #d1fae5;
            color: #065f46;
        }

        .action-btn-publish:hover {
            background: #a7f3d0;
        }

        .action-btn-unpublish {
            background: #fef3c7;
            color: #92400e;
        }

        .action-btn-unpublish:hover {
            background: #fde68a;
        }

        .action-btn-view {
            background: #ede9fe;
            color: #5b21b6;
        }

        .action-btn-view:hover {
            background: #ddd6fe;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: #718096;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }

        .modal-header {
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 24px;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2d3748;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 24px;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #2d3748;
        }

        .token-config {
            background: #ebf8ff;
            border-left: 4px solid #4299e1;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .token-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-indicator.connected {
            background: #48bb78;
        }

        .status-indicator.disconnected {
            background: #f56565;
        }

        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
            }

            .properties-table {
                overflow-x: auto;
            }

            table {
                min-width: 800px;
            }
        }

        /* Photo Management Styles */
        .help-text {
            font-size: 12px;
            color: #718096;
            margin-top: 4px;
        }

        .files-info {
            padding: 8px;
            margin-top: 8px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }

        .photos-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .photo-item {
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            cursor: move;
            transition: all 0.2s;
        }

        .photo-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .photo-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .photo-item.drag-over {
            border-color: #667eea;
            border-style: solid;
            background: #ebf4ff;
        }

        .photo-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .photo-item-number {
            font-weight: 600;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .drag-handle {
            cursor: move;
            font-size: 18px;
            color: #718096;
        }

        .photo-item-controls {
            display: flex;
            gap: 8px;
        }

        .move-btn {
            padding: 4px 12px;
            background: #e2e8f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .move-btn:hover {
            background: #cbd5e0;
        }

        .photo-item-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .photo-item img {
            max-width: 150px;
            max-height: 120px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }

        .remove-photo-btn {
            padding: 4px 12px;
            background: #fc8181;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .remove-photo-btn:hover {
            background: #f56565;
        }

        .photo-caption {
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 14px;
        }

        .photo-file-input {
            margin-bottom: 10px;
        }

        .top-bar-admin {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 999;
            background: transparent;
        }

        .burger-menu {
            display: none;
        }

        @media (max-width: 1024px) {
            .burger-menu {
                display: flex;
            }

            .top-nav .nav-links {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Drawer Menu -->
    <div id="drawer-overlay" class="drawer-overlay"></div>
    <aside id="mobile-drawer" class="mobile-drawer" aria-hidden="true">
      <div class="drawer-header">
        <span class="drawer-brand">Henri Martin Immobilier</span>
        <button id="drawer-close" class="drawer-close" aria-label="Fermer le menu">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <div class="drawer-search">
        <input type="search" placeholder="Rechercher sur le site..." aria-label="Rechercher sur le site" />
      </div>

      <nav class="drawer-nav">
        <div class="drawer-section">
          <button class="drawer-section-btn" aria-expanded="false" aria-controls="drawer-locations">
            <span>Locations</span>
            <svg class="drawer-chevron" width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <div id="drawer-locations" class="drawer-section-content">
            <a href="index.html#biens">Biens √† louer</a>
            <a href="services/estimation.html">Estimation locative</a>
            <a href="services/mise-en-location.html">Mise en location</a>
          </div>
        </div>

        <div class="drawer-section">
          <button class="drawer-section-btn" aria-expanded="false" aria-controls="drawer-ventes">
            <span>Ventes</span>
            <svg class="drawer-chevron" width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <div id="drawer-ventes" class="drawer-section-content">
            <a href="index.html#biens">Biens √† vendre</a>
            <a href="services/estimation.html">Estimation vente</a>
            <a href="ventes/off-market.html">Vendre en off-market</a>
          </div>
        </div>

        <div class="drawer-section">
          <button class="drawer-section-btn" aria-expanded="false" aria-controls="drawer-proprietaires">
            <span>Propri√©taires</span>
            <svg class="drawer-chevron" width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <div id="drawer-proprietaires" class="drawer-section-content">
            <a href="services/estimation.html">Estimation gratuite</a>
            <a href="services/rentabilite.html">Calcul de rentabilit√©</a>
            <a href="services/mise-en-location.html">Mise en location</a>
            <a href="services/modes-location.html">Modes de location</a>
          </div>
        </div>

        <div class="drawer-section">
          <button class="drawer-section-btn" aria-expanded="false" aria-controls="drawer-agence">
            <span>L'agence</span>
            <svg class="drawer-chevron" width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <div id="drawer-agence" class="drawer-section-content">
            <a href="agence/histoire.html">Histoire</a>
            <a href="agence/equipe.html">√âquipe</a>
            <a href="agence/temoignages.html">T√©moignages</a>
            <a href="agence/partenaires.html">Partenaires</a>
          </div>
        </div>

        <div class="drawer-section drawer-section-simple">
          <a href="blog.html" class="drawer-link">Blog</a>
        </div>
      </nav>

      <div class="drawer-footer">
        <a href="login.html" class="drawer-btn drawer-btn-primary">Se connecter</a>
        <a href="index.html#contact" class="drawer-btn drawer-btn-secondary">Contact</a>
      </div>
    </aside>

    <nav class="top-nav">
      <div class="container">
        <button id="burger-menu" class="burger-menu" aria-label="Ouvrir le menu" aria-expanded="false">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <a href="index.html" class="brand">Henri Martin Immobilier</a>
        <div class="nav-links">
          <a href="index.html#biens">Nos biens</a>
          <a href="services.html">Services</a>
          <a href="index.html#contact">Contact</a>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
          <a class="login-btn" href="login.html" id="loginBtn">üîê Se connecter</a>
          <a class="partner-btn" href="admin_properties.html" id="adminBtn" style="display: none; background: #10b981;">üìä G√©rer mes biens</a>
          <a class="partner-btn" href="index.html#contact">Acc√®s partenaire</a>
        </div>
      </div>
    </nav>

    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>üè¢ Gestion des biens</h1>
                    <p class="subtitle">G√©rez tous vos biens immobiliers depuis cette interface</p>
                </div>
                <a href="index.html" style="
                    padding: 10px 20px;
                    background: #f7fafc;
                    color: #4a5568;
                    text-decoration: none;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 600;
                    transition: all 0.2s;
                " onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f7fafc'">
                    üè† Retour √† l'accueil
                </a>
            </div>
        </header>

        <div class="token-config">
            <div class="token-status">
                <span class="status-indicator" id="tokenStatus"></span>
                <span id="tokenStatusText"></span>
            </div>
            <button class="btn btn-success" onclick="configureToken()">‚öôÔ∏è Configurer le token GitHub</button>
            <a href="configurer-token.html" class="btn btn-success" style="background: #10b981; text-decoration: none; display: inline-block; margin-left: 10px;">üîë Guide Configuration</a>
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalCount">-</div>
                <div class="stat-label">Total des biens</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="venteCount">-</div>
                <div class="stat-label">Biens en vente</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="locationCount">-</div>
                <div class="stat-label">Biens en location</div>
            </div>
        </div>

        <div class="toolbar">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç Rechercher par r√©f√©rence, ville, titre..." oninput="filterProperties()">
            </div>
            <div class="filter-group">
                <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">Tous</button>
                <button class="filter-btn" data-filter="vente" onclick="setFilter('vente')">Vente</button>
                <button class="filter-btn" data-filter="location" onclick="setFilter('location')">Location</button>
            </div>
            <a href="ajouter_appartement.html" class="btn">‚ûï Ajouter un bien</a>
        </div>

        <div class="properties-table">
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Chargement des biens...</p>
            </div>

            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-state-icon">üè†</div>
                <h3>Aucun bien trouv√©</h3>
                <p>Commencez par ajouter votre premier bien immobilier</p>
            </div>

            <table id="propertiesTable" style="display: none;">
                <thead>
                    <tr>
                        <th>R√©f√©rence</th>
                        <th>Transaction</th>
                        <th>Type Bien</th>
                        <th title="Type Cloudinary (vente/location)">Type Cloudinary</th>
                        <th title="Rang Cloudinary">Rang</th>
                        <th title="Dossier Cloudinary (ex: V01, LC05)">Dossier Cloudinary</th>
                        <th>Titre</th>
                        <th>Ville</th>
                        <th>Prix</th>
                        <th>Surface</th>
                        <th>Date d'ajout</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="propertiesBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">Modifier le bien</h2>
            </div>
            <form id="editForm">
                <input type="hidden" id="editReference">
                
                <div class="row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Transaction <span style="color: #e53e3e;">*</span></label>
                        <select id="editTransaction" required>
                            <option value="">-- S√©lectionner --</option>
                            <option value="vente">Vente</option>
                            <option value="location">Location</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Type de bien <span style="color: #e53e3e;">*</span></label>
                        <select id="editPropertyType" required>
                            <option value="">-- S√©lectionner --</option>
                            <option value="Appartement">Appartement</option>
                            <option value="Maison">Maison</option>
                            <option value="Villa">Villa</option>
                            <option value="Loft">Loft</option>
                            <option value="Studio">Studio</option>
                            <option value="Penthouse">Penthouse</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Titre <span style="color: #e53e3e;">*</span></label>
                    <input type="text" id="editTitle" required>
                </div>

                <div class="row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Ville <span style="color: #e53e3e;">*</span></label>
                        <input type="text" id="editCity" required>
                    </div>

                    <div class="form-group">
                        <label>Quartier <span style="color: #e53e3e;">*</span></label>
                        <input type="text" id="editDistrict" required>
                    </div>
                </div>

                <div class="row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Surface (m¬≤) <span style="color: #e53e3e;">*</span></label>
                        <input type="number" id="editSurface" required min="1">
                    </div>

                    <div class="form-group">
                        <label>Nombre de pi√®ces <span style="color: #e53e3e;">*</span></label>
                        <input type="number" id="editRooms" required min="1">
                    </div>
                </div>

                <div class="row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Nombre de chambres <span style="color: #e53e3e;">*</span></label>
                        <input type="number" id="editBedrooms" required min="0">
                    </div>

                    <div class="form-group">
                        <label>Nombre de salles d'eau <span style="color: #e53e3e;">*</span></label>
                        <input type="number" id="editBathrooms" required min="1">
                    </div>
                </div>

                <div class="row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Nombre de WC</label>
                        <input type="number" id="editWc" min="0">
                    </div>

                    <div class="form-group">
                        <label>Contact associ√©</label>
                        <input type="text" id="editContact">
                    </div>
                </div>

                <div class="form-group">
                    <label>Prix (‚Ç¨) <span style="color: #e53e3e;">*</span></label>
                    <input type="number" id="editPrice" required min="1">
                </div>

                <div class="form-group">
                    <label>Montant des charges (‚Ç¨/mois)</label>
                    <input type="number" id="editCharges" min="0">
                </div>

                <div class="form-group">
                    <label>Caract√©ristiques <span style="color: #e53e3e;">*</span></label>
                    <textarea id="editFeatures" required></textarea>
                    <div style="font-size: 12px; color: #718096; margin-top: 4px;">S√©parez par des virgules</div>
                </div>

                <div class="row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Type de chauffage <span style="color: #e53e3e;">*</span></label>
                        <select id="editHeatingType" required>
                            <option value="">-- S√©lectionner --</option>
                            <option value="collectif">Collectif</option>
                            <option value="individuel">Individuel</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>√âquipements</label>
                        <div style="display: flex; gap: 20px; margin-top: 10px;">
                            <label style="display: flex; align-items: center; font-weight: normal; cursor: pointer;">
                                <input type="checkbox" id="editElevator" style="width: auto; margin-right: 8px;">
                                Ascenseur
                            </label>
                            <label style="display: flex; align-items: center; font-weight: normal; cursor: pointer;">
                                <input type="checkbox" id="editRoommate" style="width: auto; margin-right: 8px;">
                                Colocation autoris√©e
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Photo principale</label>
                    
                    <!-- Preview of current main photo -->
                    <div id="editMainPhotoPreview" style="margin-bottom: 10px; display: none;">
                        <img id="editMainPhotoImg" src="" alt="" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 2px solid #e2e8f0; display: block; margin-bottom: 8px;">
                        <button type="button" onclick="removeMainPhotoPreview()" style="padding: 4px 12px; background: #fc8181; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" aria-label="Supprimer la photo principale">‚úï Supprimer la photo</button>
                    </div>
                    
                    <!-- File upload option -->
                    <div style="margin-bottom: 10px;">
                        <label style="font-size: 14px; color: #4a5568; display: block; margin-bottom: 4px;">Option 1: Uploader un fichier</label>
                        <input type="file" id="editMainPhotoFile" accept="image/*" class="photo-file-input" onchange="handleMainPhotoUpload(this)">
                        <div style="font-size: 12px; color: #718096; margin-top: 4px;">S√©lectionnez une image depuis votre ordinateur</div>
                    </div>
                    
                    <!-- URL option -->
                    <div>
                        <label style="font-size: 14px; color: #4a5568; display: block; margin-bottom: 4px;">Option 2: URL de la photo</label>
                        <input type="url" id="editImage" placeholder="https://example.com/photo.jpg" oninput="handleMainPhotoUrlChange(this.value)">
                        <div style="font-size: 12px; color: #718096; margin-top: 4px;">Ou entrez l'URL publique de l'image</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Description de la photo (alt text)</label>
                    <input type="text" id="editAlt" placeholder="Appartement moderne avec balcon">
                    <div style="font-size: 12px; color: #718096; margin-top: 4px;">D√©crivez la photo pour l'accessibilit√©</div>
                </div>

                <div class="form-group">
                    <label>Photos suppl√©mentaires</label>
                    <input type="file" id="editMultiplePhotos" multiple accept="image/*,application/pdf" class="photo-file-input">
                    <div class="help-text">S√©lectionnez plusieurs photos en une seule fois</div>
                    <div class="files-info" id="editFilesInfo" role="status" aria-live="polite"></div>
                </div>
                <div id="editAdditionalPhotos" class="photos-container"></div>
                <div class="help-text">üí° Glissez-d√©posez les photos pour les r√©organiser, ou utilisez les fl√®ches ‚Üë‚Üì</div>

                <div class="form-group">
                    <label>URL Fiche Canva</label>
                    <input type="url" id="editBrochureUrl">
                    <div style="font-size: 12px; color: #718096; margin-top: 4px;">URL publique de votre fiche Canva (optionnel)</div>
                </div>

                <div class="row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Type Cloudinary</label>
                        <select id="editType">
                            <option value="">-- Non d√©fini --</option>
                            <option value="vente">Vente</option>
                            <option value="location">Location</option>
                        </select>
                        <div style="font-size: 12px; color: #718096; margin-top: 4px;">Pour g√©n√©ration dossier Cloudinary</div>
                    </div>

                    <div class="form-group">
                        <label>Rang Cloudinary</label>
                        <input type="number" id="editRank" placeholder="Non d√©fini" min="1">
                        <div style="font-size: 12px; color: #718096; margin-top: 4px;">‚ö†Ô∏è Attention: La modification n√©cessite confirmation</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Dossier Cloudinary üìÅ</label>
                    <div style="display: flex; gap: 10px; align-items: flex-start;">
                        <input type="text" id="editCloudinaryFolder" placeholder="Non d√©fini (ex: V01, LC05)" readonly style="flex: 1; background: #f7fafc; cursor: not-allowed;">
                        <button type="button" onclick="toggleCloudinaryFolderEdit()" id="cloudinaryFolderEditBtn" style="padding: 10px 16px; background: #64748b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; white-space: nowrap;">
                            üîì Modifier
                        </button>
                    </div>
                    <div style="font-size: 12px; color: #718096; margin-top: 4px;">
                        üîí Le dossier Cloudinary est <strong>gel√©</strong> une fois d√©fini. Modification avanc√©e uniquement.
                    </div>
                    <div id="cloudinaryFolderWorkflowHint" style="display: none; margin-top: 8px; padding: 10px; background: #f0f9ff; border-left: 3px solid #3b82f6; border-radius: 4px;">
                        <a id="cloudinaryWorkflowLink" href="#" target="_blank" style="color: #2563eb; font-size: 13px; text-decoration: none; font-weight: 500;">
                            ‚ñ∂Ô∏è D√©clencher GitHub Actions: Cloudinary Gallery
                        </a>
                    </div>
                    
                    <!-- Cloudinary workflow dispatch button -->
                    <div style="margin-top: 12px; padding: 12px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 6px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="font-size: 14px; font-weight: 600; color: #166534;">üîÑ Synchronisation Cloudinary</span>
                        </div>
                        <p style="font-size: 12px; color: #15803d; margin-bottom: 10px;">
                            Cr√©ez ou mettez √† jour automatiquement cette fiche avec les photos du dossier Cloudinary.<br>
                            <strong>Convention:</strong> VXX = vente (ex: V01, V15), LCXX = location (ex: LC01, LC08)
                        </p>
                        <button type="button" 
                                onclick="triggerCloudinaryWorkflow()" 
                                id="cloudinaryDispatchBtn"
                                style="padding: 10px 20px; background: #16a34a; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; width: 100%;">
                            ‚ñ∂Ô∏è Cr√©er/Mettre √† jour fiche depuis Cloudinary
                        </button>
                        <div id="cloudinaryDispatchStatus" style="margin-top: 8px; font-size: 12px; display: none;"></div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Annuler</button>
                    <button type="submit" class="btn">üíæ Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration constants
        const GITHUB_OWNER = 'abbasberrada91';
        const GITHUB_REPO = 'agent-immo';
        const CLOUDINARY_FOLDER_PATTERN = /^(V\d+|LC\d+)$/;
        
        let allProperties = [];
        let currentFilter = 'all';

        // Check token status on load
        window.addEventListener('DOMContentLoaded', function() {
            updateTokenStatus();
            loadProperties();
        });

        function updateTokenStatus() {
            const token = localStorage.getItem('githubToken');
            const indicator = document.getElementById('tokenStatus');
            const text = document.getElementById('tokenStatusText');
            
            if (token) {
                indicator.classList.add('connected');
                indicator.classList.remove('disconnected');
                text.textContent = 'Token GitHub configur√© ‚úì';
            } else {
                indicator.classList.add('disconnected');
                indicator.classList.remove('connected');
                text.textContent = 'Token GitHub non configur√© - Configurez-le pour g√©rer les biens';
            }
        }

        function configureToken() {
            const currentToken = localStorage.getItem('githubToken');
            
            if (currentToken) {
                const action = confirm(
                    'Un token GitHub est actuellement configur√©.\n\n' +
                    'Cliquez sur "OK" pour le supprimer\n' +
                    'Cliquez sur "Annuler" pour le remplacer'
                );
                
                if (action) {
                    localStorage.removeItem('githubToken');
                    alert('‚úÖ Token supprim√©!');
                    updateTokenStatus();
                    return;
                }
            }
            
            // Ask if user wants guided setup
            const useGuide = confirm(
                'üîë Configuration du Token GitHub\n\n' +
                'Voulez-vous utiliser le guide pas √† pas ?\n\n' +
                '‚Ä¢ OK - Ouvrir le guide interactif (recommand√©)\n' +
                '‚Ä¢ Annuler - Entrer le token manuellement'
            );
            
            if (useGuide) {
                window.location.href = 'configurer-token.html';
            } else {
                const token = prompt(
                    'Entrez votre GitHub Personal Access Token:\n\n' +
                    'Le token doit avoir les permissions:\n' +
                    '- "repo" (acc√®s complet aux d√©p√¥ts)\n' +
                    '- "workflow" (pour d√©clencher les workflows)\n\n' +
                    'Pour cr√©er un token:\n' +
                    'GitHub ‚Üí Settings ‚Üí Developer settings ‚Üí Personal access tokens ‚Üí Tokens (classic) ‚Üí Generate new token\n\n' +
                    'Besoin d\'aide ? Utilisez le bouton "üîë Guide Configuration"'
                );
                
                if (token && token.trim()) {
                    localStorage.setItem('githubToken', token.trim());
                    alert('‚úÖ Token enregistr√© avec succ√®s!');
                    updateTokenStatus();
                } else if (token === '') {
                    const openGuide = confirm('Voulez-vous ouvrir le guide de configuration ?');
                    if (openGuide) {
                        window.location.href = 'configurer-token.html';
                    }
                }
            }
        }

        async function loadProperties() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('propertiesTable').style.display = 'none';
                document.getElementById('emptyState').style.display = 'none';

                const result = await window.propertyAPI.fetchProperties();
                allProperties = result.data.properties || [];

                updateStats();
                renderProperties();

                document.getElementById('loading').style.display = 'none';

                if (allProperties.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                } else {
                    document.getElementById('propertiesTable').style.display = 'table';
                }
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                console.error('Error loading properties:', error);
                
                // Show detailed error message with suggestions
                let errorMessage = '‚ùå Erreur lors du chargement des biens:\n\n' + error.message;
                
                // Add helpful suggestions based on error type
                if (error.message.includes('Unexpected end of JSON') || error.message.includes('incomplete or empty')) {
                    errorMessage += '\n\nüí° Suggestions:\n';
                    errorMessage += '‚Ä¢ V√©rifiez votre connexion internet\n';
                    errorMessage += '‚Ä¢ Rechargez la page (F5 ou Ctrl+R)\n';
                    errorMessage += '‚Ä¢ Videz le cache du navigateur\n';
                    errorMessage += '‚Ä¢ Le fichier biens.json est peut-√™tre trop volumineux pour votre navigateur';
                } else if (error.message.includes('JSON') || error.message.includes('parse')) {
                    errorMessage += '\n\nüí° Suggestions:\n';
                    errorMessage += '‚Ä¢ V√©rifiez la syntaxe JSON du fichier biens.json\n';
                    errorMessage += '‚Ä¢ Utilisez un validateur JSON en ligne (jsonlint.com)\n';
                    errorMessage += '‚Ä¢ Assurez-vous qu\'il n\'y a pas de virgules en trop';
                } else if (error.message.includes('Network error') || error.message.includes('Failed to fetch')) {
                    errorMessage += '\n\nüí° Suggestions:\n';
                    errorMessage += '‚Ä¢ V√©rifiez que vous √™tes bien connect√© √† internet\n';
                    errorMessage += '‚Ä¢ Le serveur GitHub n\'est peut-√™tre pas accessible\n';
                    errorMessage += '‚Ä¢ R√©essayez dans quelques instants';
                } else if (error.message.includes('404')) {
                    errorMessage += '\n\nüí° Suggestions:\n';
                    errorMessage += '‚Ä¢ V√©rifiez que biens.json existe √† la racine du projet\n';
                    errorMessage += '‚Ä¢ Assurez-vous que le fichier a √©t√© commit et push sur GitHub';
                } else if (error.message.includes('timed out') || error.message.includes('timeout')) {
                    errorMessage += '\n\nüí° Suggestions:\n';
                    errorMessage += '‚Ä¢ Le fichier est peut-√™tre trop volumineux\n';
                    errorMessage += '‚Ä¢ V√©rifiez votre connexion internet\n';
                    errorMessage += '‚Ä¢ R√©essayez dans quelques instants';
                }
                
                alert(errorMessage);
            }
        }

        function updateStats() {
            document.getElementById('totalCount').textContent = allProperties.length;
            document.getElementById('venteCount').textContent = allProperties.filter(p => p.transaction === 'vente').length;
            document.getElementById('locationCount').textContent = allProperties.filter(p => p.transaction === 'location').length;
        }

        function renderProperties() {
            const tbody = document.getElementById('propertiesBody');
            tbody.innerHTML = '';

            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = allProperties.filter(property => {
                // Apply transaction filter
                if (currentFilter !== 'all' && property.transaction !== currentFilter) {
                    return false;
                }

                // Apply search filter
                if (searchTerm) {
                    const searchableText = [
                        property.reference,
                        property.title,
                        property.city,
                        property.district,
                        property.propertyType
                    ].join(' ').toLowerCase();
                    
                    if (!searchableText.includes(searchTerm)) {
                        return false;
                    }
                }

                return true;
            });

            // Sort by date added (newest first)
            filtered.sort((a, b) => {
                const dateA = a.dateAdded ? new Date(a.dateAdded) : new Date(0);
                const dateB = b.dateAdded ? new Date(b.dateAdded) : new Date(0);
                return dateB - dateA;
            });

            filtered.forEach(property => {
                const tr = document.createElement('tr');
                
                const transactionBadge = property.transaction === 'vente' ? 
                    '<span class="badge badge-vente">Vente</span>' :
                    '<span class="badge badge-location">Location</span>';

                const isPublished = property.isPublished !== false;
                const statusBadge = isPublished ?
                    '<span class="badge badge-published">Publi√©</span>' :
                    '<span class="badge badge-draft">Brouillon</span>';
                
                const dateAdded = property.dateAdded ? 
                    new Date(property.dateAdded).toLocaleDateString('fr-FR') : 
                    '-';

                const priceFormatted = property.transaction === 'vente' ?
                    `${property.price.toLocaleString('fr-FR')} ‚Ç¨` :
                    `${property.price.toLocaleString('fr-FR')} ‚Ç¨/mois`;

                const cloudinaryTypeDisplay = property.type ? property.type : '-';
                const rankDisplay = property.rank ? property.rank : '-';
                const cloudinaryFolderDisplay = property.cloudinaryFolder ? 
                    `<span style="font-family: monospace; background: #f0f9ff; padding: 2px 6px; border-radius: 4px;">${property.cloudinaryFolder}</span>` : 
                    '-';

                tr.innerHTML = `
                    <td><strong>${property.reference}</strong></td>
                    <td>${transactionBadge}</td>
                    <td>${property.propertyType}</td>
                    <td>${cloudinaryTypeDisplay}</td>
                    <td>${rankDisplay}</td>
                    <td>${cloudinaryFolderDisplay}</td>
                    <td>${property.title}</td>
                    <td>${property.city} - ${property.district}</td>
                    <td>${priceFormatted}</td>
                    <td>${property.surface} m¬≤</td>
                    <td>${dateAdded}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="actions">
                            <button class="action-btn action-btn-edit" onclick='editProperty("${property.reference}")'>‚úèÔ∏è Modifier</button>
                            <button class="action-btn ${isPublished ? 'action-btn-unpublish' : 'action-btn-publish'}" onclick='togglePublishStatus("${property.reference}")'>${isPublished ? 'üåê D√©publier' : 'üåê Publier'}</button>
                            <button class="action-btn action-btn-view" onclick='viewProperty("${property.reference}")'>üëÅÔ∏è Voir</button>
                            <button class="action-btn action-btn-delete" onclick='deleteProperty("${property.reference}")'>üóëÔ∏è Supprimer</button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });

            if (filtered.length === 0 && allProperties.length > 0) {
                const tr = document.createElement('tr');
                // Note: Colspan must match total number of table columns (currently 13)
                tr.innerHTML = '<td colspan="13" style="text-align: center; padding: 40px; color: #718096;">Aucun bien ne correspond √† vos crit√®res de recherche</td>';
                tbody.appendChild(tr);
            }
        }

        function setFilter(filter) {
            currentFilter = filter;
            
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            renderProperties();
        }

        function filterProperties() {
            renderProperties();
        }

        function editProperty(reference) {
            const property = allProperties.find(p => p.reference === reference);
            if (!property) return;

            // Check if token is configured before opening edit modal
            const token = localStorage.getItem('githubToken');
            if (!token) {
                const proceed = confirm(
                    '‚ö†Ô∏è Token GitHub non configur√©\n\n' +
                    'Pour modifier un bien, vous devez d\'abord configurer votre token GitHub.\n\n' +
                    'Cliquez sur "OK" pour configurer le token maintenant,\n' +
                    'ou "Annuler" pour retourner √† la liste.'
                );
                
                if (proceed) {
                    configureToken();
                }
                return;
            }

            // Populate all fields
            document.getElementById('editReference').value = property.reference;
            document.getElementById('editTransaction').value = property.transaction || '';
            document.getElementById('editPropertyType').value = property.propertyType || '';
            document.getElementById('editTitle').value = property.title;
            document.getElementById('editCity').value = property.city;
            document.getElementById('editDistrict').value = property.district;
            document.getElementById('editSurface').value = property.surface;
            document.getElementById('editRooms').value = property.rooms;
            document.getElementById('editBedrooms').value = property.bedrooms !== undefined ? property.bedrooms : 1;
            document.getElementById('editBathrooms').value = property.bathrooms !== undefined ? property.bathrooms : 1;
            document.getElementById('editWc').value = property.wc || '';
            document.getElementById('editContact').value = property.contact || '';
            document.getElementById('editPrice').value = property.price;
            document.getElementById('editCharges').value = property.charges || '';
            document.getElementById('editFeatures').value = property.features ? property.features.join(', ') : '';
            document.getElementById('editHeatingType').value = property.heatingType || 'collectif';
            document.getElementById('editElevator').checked = property.elevator || false;
            document.getElementById('editRoommate').checked = property.roommateAllowed || false;
            document.getElementById('editImage').value = property.image || '';
            document.getElementById('editAlt').value = property.alt || '';
            document.getElementById('editBrochureUrl').value = property.brochureUrl || '';

            // Populate Cloudinary fields
            document.getElementById('editType').value = property.type || '';
            document.getElementById('editRank').value = property.rank || '';
            document.getElementById('editCloudinaryFolder').value = property.cloudinaryFolder || '';
            
            // Store original values for comparison
            window.originalRank = property.rank;
            window.originalCloudinaryFolder = property.cloudinaryFolder;
            
            // Reset cloudinaryFolder edit state
            const folderInput = document.getElementById('editCloudinaryFolder');
            folderInput.readOnly = true;
            folderInput.style.background = '#f7fafc';
            folderInput.style.cursor = 'not-allowed';
            document.getElementById('cloudinaryFolderEditBtn').textContent = 'üîì Modifier';
            
            // Show workflow link if cloudinaryFolder exists
            if (property.cloudinaryFolder) {
                const workflowUrl = window.AppConfig?.cloudinary?.getWorkflowUrl 
                    ? window.AppConfig.cloudinary.getWorkflowUrl(property.cloudinaryFolder)
                    : `https://github.com/${GITHUB_OWNER}/${GITHUB_REPO}/actions/workflows/cloudinary-gallery.yml`;
                
                document.getElementById('cloudinaryWorkflowLink').href = workflowUrl;
                document.getElementById('cloudinaryFolderWorkflowHint').style.display = 'block';
            } else {
                document.getElementById('cloudinaryFolderWorkflowHint').style.display = 'none';
            }

            // Display main photo preview if exists
            updateMainPhotoPreview(property.image || '');

            // Load existing additional photos
            editPhotosData = [];
            if (property.additionalPhotos && Array.isArray(property.additionalPhotos)) {
                editPhotosData = property.additionalPhotos.map((photo, index) => ({
                    id: Date.now() + '-' + index + '-' + Math.random().toString(36).substr(2, 9),
                    filename: photo.filename,
                    caption: photo.caption || '',
                    type: photo.type || 'image/jpeg',
                    size: photo.size || 0,
                    data: photo.data || photo.preview || '',
                    isExisting: true
                }));
            }
            renderEditPhotosList();

            document.getElementById('editModal').classList.add('show');
        }

        // Main photo handling functions
        let editMainPhotoData = null; // Store base64 data for uploaded file

        function updateMainPhotoPreview(imageUrl) {
            const previewDiv = document.getElementById('editMainPhotoPreview');
            const previewImg = document.getElementById('editMainPhotoImg');
            
            if (imageUrl) {
                previewImg.src = imageUrl;
                // Set alt text based on property title if available
                const titleField = document.getElementById('editTitle');
                const altField = document.getElementById('editAlt');
                if (altField && altField.value) {
                    previewImg.alt = altField.value;
                } else if (titleField && titleField.value) {
                    previewImg.alt = 'Aper√ßu: ' + titleField.value;
                } else {
                    previewImg.alt = 'Aper√ßu de la photo principale';
                }
                previewDiv.style.display = 'block';
            } else {
                previewDiv.style.display = 'none';
            }
        }

        async function handleMainPhotoUpload(input) {
            const file = input.files[0];
            if (file) {
                try {
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        alert('‚ùå Erreur: Le fichier doit √™tre une image.');
                        input.value = '';
                        return;
                    }
                    
                    // Validate file size (max 10MB before compression)
                    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
                    if (file.size > MAX_FILE_SIZE) {
                        alert(`‚ùå Le fichier est trop volumineux (${(file.size / 1024 / 1024).toFixed(2)}MB). Maximum: 10MB.`);
                        input.value = '';
                        return;
                    }
                    
                    // Convert to base64 with compression
                    const base64Data = await compressImage(file);
                    editMainPhotoData = base64Data;
                    
                    // Update preview
                    updateMainPhotoPreview(base64Data);
                    
                    // Clear URL input since we're using uploaded file
                    document.getElementById('editImage').value = '';
                } catch (error) {
                    console.error('Error uploading photo:', error);
                    alert('‚ùå Erreur lors du chargement de la photo. Veuillez r√©essayer.');
                    input.value = '';
                }
            }
        }

        function handleMainPhotoUrlChange(url) {
            if (url) {
                // Clear file input and data since we're using URL
                document.getElementById('editMainPhotoFile').value = '';
                editMainPhotoData = null;
                
                // Validate URL by attempting to load it
                const img = new Image();
                img.onload = function() {
                    // Image loaded successfully
                    updateMainPhotoPreview(url);
                };
                img.onerror = function() {
                    // Image failed to load
                    console.warn('Failed to load image from URL:', url);
                    // Still show the URL for manual verification, but don't hide preview
                    updateMainPhotoPreview(url);
                };
                img.src = url;
            } else {
                // If URL is cleared and no file uploaded, hide preview
                if (!editMainPhotoData) {
                    document.getElementById('editMainPhotoPreview').style.display = 'none';
                }
            }
        }

        function removeMainPhotoPreview() {
            // Clear both inputs and data
            document.getElementById('editImage').value = '';
            document.getElementById('editMainPhotoFile').value = '';
            editMainPhotoData = null;
            
            // Hide preview
            document.getElementById('editMainPhotoPreview').style.display = 'none';
        }

        // Photo management variables for edit modal
        let editPhotoCount = 0;
        let editPhotosData = [];
        let editDraggedIndex = null;

        // Handle multiple file selection for edit
        document.addEventListener('DOMContentLoaded', function() {
            const editInput = document.getElementById('editMultiplePhotos');
            if (editInput) {
                editInput.addEventListener('change', async function(e) {
                    const files = Array.from(e.target.files);
                    for (const file of files) {
                        await addEditPhotoFromFile(file);
                    }
                    updateEditFilesInfo();
                    e.target.value = ''; // Reset input to allow selecting the same file again
                });
            }
        });

        async function addEditPhotoFromFile(file) {
            // Validate file size (max 10MB before compression)
            const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
            if (file.size > MAX_FILE_SIZE) {
                alert(`‚ùå Le fichier "${file.name}" est trop volumineux (${(file.size / 1024 / 1024).toFixed(2)}MB). Maximum: 10MB. Veuillez utiliser une image plus petite.`);
                return;
            }

            editPhotoCount++;
            const photoId = Date.now() + '-' + editPhotoCount + '-' + Math.random().toString(36).substr(2, 9);
            
            // Use compression for images
            const base64Data = await compressImage(file);
            
            // Calculate compressed size
            const compressedSize = Math.round((base64Data.length * 3) / 4); // Estimate binary size from base64 string
            
            // Store photo data
            editPhotosData.push({
                id: photoId,
                file: file,
                filename: file.name,
                caption: '',
                type: file.type.startsWith('image/') ? 'image/jpeg' : file.type, // Compressed images are JPEG
                size: compressedSize,
                data: base64Data,
                isExisting: false
            });
            
            renderEditPhotosList();
            
            // Calculate total size and warn if approaching limit
            const totalSize = editPhotosData.reduce((sum, photo) => sum + (photo.size || 0), 0);
            const totalSizeMB = (totalSize / 1024 / 1024).toFixed(2);
            const WARNING_SIZE = 50 * 1024 * 1024; // 50MB warning threshold
            
            if (totalSize > WARNING_SIZE) {
                alert(`‚ö†Ô∏è Attention: La taille totale des photos est de ${totalSizeMB}MB. GitHub a une limite de fichier, veuillez ne pas ajouter trop de photos suppl√©mentaires.`);
            }
        }

        /**
         * Compress an image file to reduce size
         * @param {File} file - Image file to compress
         * @param {number} maxWidth - Maximum width (default: 1920)
         * @param {number} maxHeight - Maximum height (default: 1080)
         * @param {number} quality - JPEG quality 0-1 (default: 0.85)
         * @returns {Promise<string>} Base64 encoded compressed image
         */
        async function compressImage(file, maxWidth = 1920, maxHeight = 1080, quality = 0.85) {
            return new Promise((resolve, reject) => {
                // Only compress images
                if (!file.type.startsWith('image/')) {
                    // For non-images, just convert to base64
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        // Calculate new dimensions
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth || height > maxHeight) {
                            const ratio = Math.min(maxWidth / width, maxHeight / height);
                            width = Math.floor(width * ratio);
                            height = Math.floor(height * ratio);
                        }
                        
                        // Create canvas and compress
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to base64 with compression
                        const compressed = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressed);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function renderEditPhotosList() {
            const container = document.getElementById('editAdditionalPhotos');
            container.innerHTML = '';
            
            editPhotosData.forEach((photo, index) => {
                const photoItem = createEditPhotoItem(photo, index);
                container.appendChild(photoItem);
            });
            
            updateEditFilesInfo();
        }

        function createEditPhotoItem(photo, index) {
            const div = document.createElement('div');
            div.className = 'photo-item';
            div.draggable = true;
            div.dataset.photoId = photo.id;
            div.dataset.index = index;
            
            // Create preview
            let previewHtml = '';
            if (photo.type.startsWith('image/')) {
                previewHtml = `<img src="${photo.data}" alt="Preview">`;
            } else if (photo.type === 'application/pdf') {
                previewHtml = `<p style="color: #4299e1;">üìÑ PDF: ${photo.filename}</p>`;
            }
            
            div.innerHTML = `
                <div class="photo-item-header">
                    <div class="photo-item-number">
                        <span class="drag-handle" role="img" aria-label="Poign√©e de glissement">‚ãÆ‚ãÆ</span>
                        <span>Photo ${index + 1}</span>
                    </div>
                    <div class="photo-item-controls">
                        <button type="button" class="move-btn" onclick="moveEditPhoto(${index}, -1)" ${index === 0 ? 'disabled' : ''} aria-label="D√©placer la photo vers le haut">‚Üë</button>
                        <button type="button" class="move-btn" onclick="moveEditPhoto(${index}, 1)" ${index === editPhotosData.length - 1 ? 'disabled' : ''} aria-label="D√©placer la photo vers le bas">‚Üì</button>
                        <button type="button" class="remove-photo-btn" onclick="removeEditPhoto('${photo.id}')" aria-label="Supprimer cette photo">‚úï</button>
                    </div>
                </div>
                <div class="photo-item-content">
                    ${previewHtml}
                    <label>Nom du fichier: ${photo.filename}</label>
                    <label for="edit-caption-${photo.id}">L√©gende</label>
                    <input type="text" 
                           id="edit-caption-${photo.id}"
                           class="photo-caption" 
                           placeholder="D√©crivez cette photo" 
                           value="${photo.caption}"
                           onchange="updateEditPhotoCaption('${photo.id}', this.value)"
                           aria-label="L√©gende de la photo ${index + 1}">
                </div>
            `;
            
            // Add drag and drop event listeners
            div.addEventListener('dragstart', handleEditDragStart);
            div.addEventListener('dragend', handleEditDragEnd);
            div.addEventListener('dragover', handleEditDragOver);
            div.addEventListener('drop', handleEditDrop);
            div.addEventListener('dragenter', handleEditDragEnter);
            div.addEventListener('dragleave', handleEditDragLeave);
            
            return div;
        }

        function updateEditPhotoCaption(photoId, caption) {
            const photo = editPhotosData.find(p => p.id === photoId);
            if (photo) {
                photo.caption = caption;
            }
        }

        function removeEditPhoto(photoId) {
            editPhotosData = editPhotosData.filter(p => p.id !== photoId);
            renderEditPhotosList();
            updateEditFilesInfo();
        }

        function moveEditPhoto(index, direction) {
            if (direction === -1 && index > 0) {
                // Move up
                [editPhotosData[index - 1], editPhotosData[index]] = [editPhotosData[index], editPhotosData[index - 1]];
            } else if (direction === 1 && index < editPhotosData.length - 1) {
                // Move down
                [editPhotosData[index], editPhotosData[index + 1]] = [editPhotosData[index + 1], editPhotosData[index]];
            }
            renderEditPhotosList();
        }

        function updateEditFilesInfo() {
            const filesInfo = document.getElementById('editFilesInfo');
            if (editPhotosData.length > 0) {
                filesInfo.textContent = `${editPhotosData.length} photo(s) ajout√©e(s)`;
            } else {
                filesInfo.textContent = '';
            }
        }

        // Drag and drop handlers for edit modal
        function handleEditDragStart(e) {
            this.classList.add('dragging');
            editDraggedIndex = parseInt(this.dataset.index);
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleEditDragEnd(e) {
            this.classList.remove('dragging');
            
            // Remove drag-over class from all items
            document.querySelectorAll('.photo-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        function handleEditDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleEditDragEnter(e) {
            this.classList.add('drag-over');
        }

        function handleEditDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleEditDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (editDraggedIndex !== null) {
                const targetIndex = parseInt(this.dataset.index);
                
                // Swap the photos in the array using destructuring
                [editPhotosData[editDraggedIndex], editPhotosData[targetIndex]] = [editPhotosData[targetIndex], editPhotosData[editDraggedIndex]];
                
                renderEditPhotosList();
            }
            
            return false;
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
            // Clean up photos data
            editPhotosData = [];
            editPhotoCount = 0;
            editMainPhotoData = null;
            // Hide main photo preview
            document.getElementById('editMainPhotoPreview').style.display = 'none';
        }

        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const reference = document.getElementById('editReference').value;
            const updates = {
                transaction: document.getElementById('editTransaction').value,
                propertyType: document.getElementById('editPropertyType').value,
                title: document.getElementById('editTitle').value,
                city: document.getElementById('editCity').value,
                district: document.getElementById('editDistrict').value,
                surface: parseInt(document.getElementById('editSurface').value),
                rooms: parseInt(document.getElementById('editRooms').value),
                bedrooms: parseInt(document.getElementById('editBedrooms').value),
                bathrooms: parseInt(document.getElementById('editBathrooms').value),
                price: parseInt(document.getElementById('editPrice').value),
                features: document.getElementById('editFeatures').value.split(',').map(f => f.trim()).filter(f => f),
                heatingType: document.getElementById('editHeatingType').value,
                elevator: document.getElementById('editElevator').checked,
                roommateAllowed: document.getElementById('editRoommate').checked
            };

            // Add optional fields only if they have values
            const wcValue = document.getElementById('editWc').value;
            if (wcValue && wcValue.trim() !== '') {
                updates.wc = parseInt(wcValue);
            }

            const contactValue = document.getElementById('editContact').value;
            if (contactValue && contactValue.trim() !== '') {
                updates.contact = contactValue.trim();
            }

            const chargesValue = document.getElementById('editCharges').value;
            if (chargesValue && chargesValue.trim() !== '') {
                updates.charges = parseInt(chargesValue);
            }

            const brochureUrlValue = document.getElementById('editBrochureUrl').value;
            if (brochureUrlValue && brochureUrlValue.trim() !== '') {
                updates.brochureUrl = brochureUrlValue.trim();
            }

            // Handle Cloudinary fields with safeguards
            const typeValue = document.getElementById('editType').value;
            if (typeValue) {
                updates.type = typeValue;
            }

            // Get submit button reference once for better performance
            const submitBtn = e.target.querySelector('button[type="submit"]');

            const rankValue = document.getElementById('editRank').value;
            if (rankValue && rankValue.trim() !== '') {
                const newRank = parseInt(rankValue, 10);
                // Check if rank changed and needs confirmation
                if (window.originalRank !== undefined && window.originalRank !== newRank) {
                    const confirmRank = confirm(
                        `‚ö†Ô∏è ATTENTION: Modification du rang\n\n` +
                        `Ancien rang: ${window.originalRank}\n` +
                        `Nouveau rang: ${newRank}\n\n` +
                        `Le rang est normalement calcul√© automatiquement √† la cr√©ation.\n` +
                        `√ätes-vous s√ªr de vouloir modifier ce rang manuellement?\n\n` +
                        `Note: Cette modification ne changera PAS le dossier Cloudinary (gel√©).`
                    );
                    
                    if (!confirmRank) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'üíæ Enregistrer';
                        return; // Abort submission
                    }
                    updates._confirmRankChange = true;
                }
                updates.rank = newRank;
            }

            const cloudinaryFolderValue = document.getElementById('editCloudinaryFolder').value;
            if (cloudinaryFolderValue && cloudinaryFolderValue.trim() !== '' && cloudinaryFolderValue !== window.originalCloudinaryFolder) {
                // CloudinaryFolder changed - check if override is allowed
                const folderInput = document.getElementById('editCloudinaryFolder');
                if (folderInput.readOnly) {
                    // Should not happen in normal flow, but handle gracefully
                    alert('‚ö†Ô∏è Le dossier Cloudinary est gel√©. Utilisez le bouton "üîì Modifier" pour le d√©bloquer.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üíæ Enregistrer';
                    return;
                }
                
                const confirmFolder = confirm(
                    `üî¥ AVERTISSEMENT IMPORTANT: Modification du dossier Cloudinary\n\n` +
                    `Ancien dossier: ${window.originalCloudinaryFolder || '(vide)'}\n` +
                    `Nouveau dossier: ${cloudinaryFolderValue}\n\n` +
                    `‚ö†Ô∏è Le dossier Cloudinary est un identifiant externe qui doit rester stable.\n` +
                    `‚ö†Ô∏è Cette modification est IRR√âVERSIBLE et peut casser les r√©f√©rences aux images.\n\n` +
                    `√ätes-vous absolument certain de vouloir continuer?`
                );
                
                if (!confirmFolder) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üíæ Enregistrer';
                    return; // Abort submission
                }
                updates.cloudinaryFolder = cloudinaryFolderValue.trim();
                updates._allowCloudinaryFolderOverride = true;
            }

            // Add photo fields if they have values
            // Note: Base64 images are not supported - only URLs are allowed
            const imageValue = document.getElementById('editImage').value;
            if (imageValue && imageValue.trim() !== '') {
                updates.image = imageValue.trim();
            }

            const altValue = document.getElementById('editAlt').value;
            if (altValue && altValue.trim() !== '') {
                updates.alt = altValue.trim();
            }

            // Note: additionalPhotos with base64 data is not supported as it exceeds GitHub API limits.
            // The validation in api.js will reject any base64 images.
            // Only URL-based images are allowed in the image and images fields.

            // Set loading state on submit button
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Enregistrement...';

            const result = await window.propertyAPI.updateProperty(reference, updates);

            if (result.success) {
                alert('‚úÖ ' + result.message);
                closeEditModal();
                await loadProperties(); // Reload to show changes
            } else if (result.error === 'RANK_CHANGE_NEEDS_CONFIRMATION') {
                // Special handling for rank change confirmation
                alert(
                    `‚ö†Ô∏è ${result.message}\n\n` +
                    `Ancien rang: ${result.oldRank}\n` +
                    `Nouveau rang: ${result.newRank}\n\n` +
                    `Veuillez confirmer ce changement en cliquant √† nouveau sur "Enregistrer".`
                );
            } else {
                alert('‚ùå ' + result.message);
            }

            submitBtn.disabled = false;
            submitBtn.textContent = 'üíæ Enregistrer';
        });

        async function togglePublishStatus(reference) {
            const property = allProperties.find(p => p.reference === reference);
            if (!property) return;

            const isPublished = property.isPublished !== false;
            const action = isPublished ? 'd√©publier' : 'publier';

            const confirmed = confirm(
                `Voulez-vous ${action} ce bien ?\n\n` +
                `R√©f√©rence: ${reference}\n` +
                `Titre: ${property.title}`
            );

            if (!confirmed) return;

            const result = await window.propertyAPI.togglePropertyStatus(reference);

            if (result.success) {
                alert('‚úÖ ' + result.message);
                await loadProperties(); // Reload to show changes
            } else {
                alert('‚ùå ' + result.message);
            }
        }

        function viewProperty(reference) {
            window.open(`detail.html?ref=${encodeURIComponent(reference)}`, '_blank');
        }

        async function deleteProperty(reference) {
            const property = allProperties.find(p => p.reference === reference);
            if (!property) return;

            const confirmed = confirm(
                `√ätes-vous s√ªr de vouloir supprimer ce bien ?\n\n` +
                `R√©f√©rence: ${reference}\n` +
                `Titre: ${property.title}\n` +
                `Ville: ${property.city}\n\n` +
                `Cette action est irr√©versible.`
            );

            if (!confirmed) return;

            const result = await window.propertyAPI.deleteProperty(reference);

            if (result.success) {
                alert('‚úÖ ' + result.message);
                await loadProperties(); // Reload to show changes
            } else {
                alert('‚ùå ' + result.message);
            }
        }

        // Close modal when clicking outside
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        // Toggle cloudinaryFolder edit mode
        function toggleCloudinaryFolderEdit() {
            const folderInput = document.getElementById('editCloudinaryFolder');
            const btn = document.getElementById('cloudinaryFolderEditBtn');
            
            if (folderInput.readOnly) {
                // Enable editing
                const confirmed = confirm(
                    `‚ö†Ô∏è AVERTISSEMENT: Modifier le dossier Cloudinary\n\n` +
                    `Le dossier Cloudinary est un identifiant externe qui doit normalement rester stable.\n` +
                    `Une fois d√©fini, il ne doit PAS √™tre modifi√© car il sert de r√©f√©rence pour les images.\n\n` +
                    `Modifier ce dossier peut casser les r√©f√©rences aux images existantes.\n\n` +
                    `Voulez-vous vraiment activer la modification de ce champ?`
                );
                
                if (confirmed) {
                    folderInput.readOnly = false;
                    folderInput.style.background = '#fff';
                    folderInput.style.cursor = 'text';
                    btn.textContent = 'üîí Verrouiller';
                    btn.style.background = '#ef4444';
                }
            } else {
                // Disable editing
                folderInput.readOnly = true;
                folderInput.style.background = '#f7fafc';
                folderInput.style.cursor = 'not-allowed';
                btn.textContent = 'üîì Modifier';
                btn.style.background = '#64748b';
            }
        }

        // Trigger Cloudinary workflow to create/update fiche
        async function triggerCloudinaryWorkflow() {
            const statusDiv = document.getElementById('cloudinaryDispatchStatus');
            const button = document.getElementById('cloudinaryDispatchBtn');
            
            // Get folder from the input fields
            const folderInput = document.getElementById('editCloudinaryFolder');
            const referenceInput = document.getElementById('editReference');
            
            let folder = folderInput.value.trim();
            
            // If cloudinaryFolder is empty, try to use reference
            if (!folder) {
                folder = referenceInput.value.trim();
            }
            
            if (!folder) {
                statusDiv.style.display = 'block';
                statusDiv.style.color = '#dc2626';
                statusDiv.textContent = '‚ùå Erreur: Aucun dossier Cloudinary sp√©cifi√©. Veuillez renseigner le champ "Dossier Cloudinary" ou "R√©f√©rence".';
                return;
            }
            
            // Validate folder naming convention
            const normalizedFolder = folder.toUpperCase();
            if (!normalizedFolder.match(CLOUDINARY_FOLDER_PATTERN)) {
                const useAnyway = confirm(
                    `‚ö†Ô∏è Avertissement: Le dossier "${folder}" ne suit pas la convention de nommage standard.\n\n` +
                    `Convention attendue:\n` +
                    `- VXX pour vente (ex: V01, V15)\n` +
                    `- LCXX pour location (ex: LC01, LC08)\n\n` +
                    `Voulez-vous continuer quand m√™me?`
                );
                
                if (!useAnyway) {
                    return;
                }
            }
            
            // Get GitHub token
            const token = localStorage.getItem('githubToken');
            if (!token) {
                statusDiv.style.display = 'block';
                statusDiv.style.color = '#dc2626';
                statusDiv.textContent = '‚ùå Erreur: Token GitHub non configur√©. Veuillez configurer votre token GitHub dans les param√®tres.';
                return;
            }
            
            // Disable button and show loading
            button.disabled = true;
            button.style.opacity = '0.6';
            button.style.cursor = 'not-allowed';
            statusDiv.style.display = 'block';
            statusDiv.style.color = '#2563eb';
            statusDiv.textContent = '‚è≥ D√©clenchement du workflow en cours...';
            
            try {
                // Dispatch workflow via GitHub API
                const response = await fetch(
                    `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/actions/workflows/cloudinary-gallery.yml/dispatches`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ref: 'main',
                            inputs: {
                                folder: folder
                            }
                        })
                    }
                );
                
                if (response.status === 204) {
                    // Success
                    statusDiv.style.color = '#16a34a';
                    statusDiv.innerHTML = `‚úÖ Workflow d√©clench√© avec succ√®s!<br>` +
                        `Dossier: <strong>${folder}</strong><br>` +
                        `Le workflow va cr√©er/mettre √† jour la fiche dans 1-2 minutes.<br>` +
                        `<a href="https://github.com/${GITHUB_OWNER}/${GITHUB_REPO}/actions" target="_blank" rel="noopener noreferrer" style="color: #2563eb;">Voir le statut sur GitHub Actions</a>`;
                    
                    // Show success message
                    alert(
                        `‚úÖ Workflow d√©clench√© avec succ√®s!\n\n` +
                        `Dossier Cloudinary: ${folder}\n\n` +
                        `Le workflow GitHub Actions va:\n` +
                        `1. R√©cup√©rer les images du dossier "${folder}"\n` +
                        `2. Cr√©er ou mettre √† jour la fiche dans biens.json\n` +
                        `3. Committer et pousser les changements\n\n` +
                        `Cela prendra environ 1-2 minutes.\n` +
                        `Rechargez la page apr√®s quelques minutes pour voir les changements.`
                    );
                } else {
                    // Error
                    const errorText = await response.text();
                    console.error('Workflow dispatch error:', errorText);
                    statusDiv.style.color = '#dc2626';
                    statusDiv.textContent = `‚ùå Erreur ${response.status}: ${errorText || 'Impossible de d√©clencher le workflow'}`;
                }
                
            } catch (error) {
                console.error('Error triggering workflow:', error);
                statusDiv.style.color = '#dc2626';
                statusDiv.textContent = `‚ùå Erreur: ${error.message}`;
            } finally {
                // Re-enable button
                button.disabled = false;
                button.style.opacity = '1';
                button.style.cursor = 'pointer';
            }
        }
    </script>
    <script src="drawer.js"></script>
</body>
</html>
